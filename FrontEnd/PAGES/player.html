<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistir Filme ou Série - StarMovies</title>
    <link rel="stylesheet" href="/GERAL/StyleWatch.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="/IMG/Logo1.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo">
                <h1>StarMovies</h1>
            </div>
            <nav>
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <ul>
                    <li><a href="/index.html">Início</a></li>
                    <li><a href="/PAGES/filmes.html">Filmes</a></li>
                    <li><a href="/PAGES/series.html">Séries</a></li>
                    <li><a href="/PAGES/Generos.html">Gêneros</a></li>
                    <li><a href="/PAGES/sobre.html">Sobre</a></li>
                    <li class="search">
                        <form role="search" onsubmit="return false;" style="position: relative;">
                            <input type="text" placeholder="Buscar filmes ou séries..." id="search-input" autocomplete="off" aria-label="Buscar filmes ou séries">
                            <button type="submit" aria-label="Pesquisar"><i class="fas fa-search"></i></button>
                            <div id="sugestoes"></div>
                        </form>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main id="player-container" aria-live="polite">
        <div id="loader" class="loader">
            <div class="spinner"></div>
            <p>Carregando filme, por favor aguarde...</p>
        </div>
        <h2 id="titulo-serie">Carregando título...</h2>
        <div class="player-wrapper">
            <div id="player-overlay" class="player-overlay" role="button" tabindex="0" aria-label="Iniciar reprodução">
                <i class="fas fa-play"></i>
            </div>
            <iframe id="player" loading="lazy" frameborder="0" allowfullscreen aria-label="Player de vídeo"></iframe>
            <div id="player-error" class="error-message hidden">
                <p>Erro ao carregar o vídeo. Tente novamente ou entre em contato com o suporte.</p>
                <button id="retry-btn" class="retry-btn">Tentar novamente</button>
            </div>
        </div>
        <section id="detalhes-filme">
            <div id="info-filme">
                <h3 id="movie-name">Nome do Filme</h3>
                <p id="generos">Gêneros: Carregando...</p>
                <p id="descricao">Carregando descrição...</p>
                <p id="qualidade">Qualidade: Carregando...</p>
            </div>
            <img id="capa" src="/IMG/placeholder.jpg" alt="Capa do Filme" />
        </section>

        <!-- Ad: One 300x250 -->
        <section class="ads-container" aria-label="Anúncios">
            <div class="ad-container ad-300x250">
                <div class="anuncio">
                    <script type="text/javascript">
                        atOptions = {
                            'key': 'ce04a28c61dd91222942a54edcdfefa3',
                            'format': 'iframe',
                            'height': 250,
                            'width': 300,
                            'params': {}
                        };
                    </script>
                    <script type="text/javascript" src="//www.highperformanceformat.com/ce04a28c61dd91222942a54edcdfefa3/invoke.js" defer></script>
                </div>
            </div>
        </section>
    </main>

    <!-- Floating Ad -->
    <script async="async" data-cfasync="false" src="//pl26406530.profitableratecpm.com/6212237595b591e4197a075fd5b8b929/invoke.js" defer></script>
    <div id="container-6212237595b591e4197a075fd5b8b929"></div>

    <footer>
        <div class="footer-container">
            <div class="footer-section">
                <h3>StarMovies</h3>
                <p>Explore um universo de filmes e séries com a melhor curadoria de conteúdo.</p>
            </div>
            <div class="footer-section">
                <h3>Navegação</h3>
                <ul>
                    <li><a href="/index.html">Início</a></li>
                    <li><a href="/PAGES/filmes.html">Filmes</a></li>
                    <li><a href="/PAGES/series.html">Séries</a></li>
                    <li><a href="/PAGES/Generos.html">Gêneros</a></li>
                    <li><a href="/PAGES/sobre.html">Sobre</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Contato</h3>
                <p>Email: contato@starmovies.com</p>
                <p>Siga-nos nas redes sociais:</p>
                <div class="social-links">
                    <a href="#">Facebook</a>
                    <a href="#">Twitter</a>
                    <a href="#">Instagram</a>
                </div>
            </div>
        </div>
        <p>© 2025 StarMovies - Todos os direitos reservados.</p>
    </footer>

    <script src="/Conex/Config.js" defer></script>
    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get("id");
            const playerContainer = document.getElementById("player-container");
            const loader = document.getElementById("loader");
            const player = document.getElementById("player");
            const playerOverlay = document.getElementById("player-overlay");
            const playerError = document.getElementById("player-error");
            const retryBtn = document.getElementById("retry-btn");

            if (!id) {
                loader.classList.add("hidden");
                playerContainer.innerHTML = '<p class="error-message">Erro: Nenhum ID fornecido na URL.</p>';
                return;
            }

            async function fetchContent(id) {
                const filmeUrl = `${BACKEND_URL}/filme/detalhes?id=${id}`;
                const serieUrl = `${BACKEND_URL}/serie/detalhes?id=${id}`;

                const [filmeResponse, serieResponse] = await Promise.all([
                    fetch(filmeUrl, {
                        headers: { 'X-API-Key': API_KEY }
                    }).then(res => res.ok ? res.json() : { erro: 'Erro ao buscar filme' }).catch(() => ({ erro: 'Erro ao buscar filme' })),
                    fetch(serieUrl, {
                        headers: { 'X-API-Key': API_KEY }
                    }).then(res => res.ok ? res.json() : { erro: 'Erro ao buscar série' }).catch(() => ({ erro: 'Erro ao buscar série' }))
                ]);

                if (!filmeResponse.erro) {
                    return { data: filmeResponse, type: 'filme' };
                } else if (!serieResponse.erro) {
                    return { data: serieResponse, type: 'serie' };
                } else {
                    return { erro: 'Filme ou série não encontrado' };
                }
            }

            async function loadPlayerContent(id, type, title) {
                loader.classList.remove("hidden");
                playerError.classList.add("hidden");
                playerOverlay.classList.add("hidden");

                try {
                    const playerSrc = `https://superflixapi.nexus/${type}/${id}`;
                    player.src = playerSrc;
                    player.title = `Assistindo ${title}`;
                    player.classList.add("loaded");

                    // Wait for iframe to load or timeout after 10 seconds
                    await Promise.race([
                        new Promise(resolve => player.onload = resolve),
                        new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 10000))
                    ]);
                } catch (error) {
                    console.error("Erro ao carregar player:", error);
                    player.src = "";
                    player.classList.remove("loaded");
                    playerError.classList.remove("hidden");
                    playerOverlay.classList.remove("hidden");
                } finally {
                    loader.classList.add("hidden");
                }
            }

            loader.classList.remove("hidden");

            const result = await fetchContent(id);

            if (result.erro) {
                loader.classList.add("hidden");
                playerContainer.innerHTML = '<p class="error-message">Filme ou série não encontrado. Verifique o ID ou tente novamente mais tarde.</p>';
                document.getElementById("titulo-serie").textContent = "Erro ao carregar";
                return;
            }

            const { data, type } = result;
            updatePlayerContent(data);

            function updatePlayerContent(content) {
                const {
                    titulo = "Título indisponível",
                    descricao = "Descrição não disponível",
                    capa = "/IMG/placeholder.jpg",
                    generos = ["Não especificado"],
                    qualidade = "Qualidade desconhecida"
                } = content;

                document.getElementById("titulo-serie").textContent = `Assistindo: ${titulo}`;
                document.getElementById("movie-name").textContent = titulo;
                document.getElementById("descricao").textContent = descricao;
                document.getElementById("generos").textContent = `Gêneros: ${Array.isArray(generos) ? generos.join(", ") : generos}`;
                document.getElementById("qualidade").textContent = `Qualidade: ${qualidade}`;
                document.getElementById("capa").src = capa;
                document.getElementById("capa").alt = `Capa de ${titulo}`;

                // Initialize player on play button click
                playerOverlay.addEventListener("click", () => loadPlayerContent(id, type, titulo));
                playerOverlay.addEventListener("keydown", (e) => {
                    if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        loadPlayerContent(id, type, titulo);
                    }
                });

                // Retry button functionality
                retryBtn.addEventListener("click", () => loadPlayerContent(id, type, titulo));
            }

            // Hamburger menu toggle
            const hamburger = document.querySelector('.hamburger');
            const navMenu = document.querySelector('nav ul');
            hamburger.addEventListener('click', () => {
                navMenu.classList.toggle('active');
                hamburger.classList.toggle('open');
            });
        });
    </script>
</body>
</html>